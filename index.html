<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Scenario Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes flash {
            0%, 100% { background-color: #fecaca; color: #b91c1c; } /* red-200 bg, red-700 text */
            50% { background-color: #b91c1c; color: white; } /* red-700 bg, white text */
        }
        .animate-flash {
            animation: flash 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <!-- Main container for the flight information card -->
    <div id="flightCard" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in hidden">
        <!-- Status Section -->
        <div class="p-6 border-b border-slate-200">
             <div class="flex items-center">
                <div class="mr-4">
                     <p class="text-sm font-bold uppercase tracking-wider" id="statusLabel">Flight Status</p>
                </div>
                <div class="flex-grow">
                     <p id="delayStatus" class="font-bold text-xl rounded-lg px-4 py-2 text-center"></p>
                </div>
            </div>
        </div>
        
        <div class="p-6 sm:p-8">
            <!-- Route Information -->
            <div class="flex items-center justify-between mb-8 pb-8 border-b border-slate-200">
                <div class="text-left">
                    <p id="iataFrom" class="text-4xl font-bold text-slate-800"></p>
                    <p id="fromCityCountry" class="text-slate-500"></p>
                </div>
                <div class="flex items-center text-slate-400">
                    <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"></path></svg>
                </div>
                <div class="text-right">
                    <p id="iataTo" class="text-4xl font-bold text-slate-800"></p>
                    <p id="toCityCountry" class="text-slate-500"></p>
                </div>
            </div>

            <!-- Main Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Flight Details Section -->
                <div class="md-col-span-1 space-y-6">
                    <h3 class="font-bold text-lg text-slate-700 border-b pb-2">Flight Details</h3>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Flight Number</label>
                        <p class="text-slate-800 font-semibold text-lg">QF<span id="flightNumber"></span></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Departure Time</label>
                        <p id="departScheduled" class="text-slate-800 font-semibold text-lg"></p>
                    </div>
                    <div id="newDepartureTimeContainer" class="hidden">
                        <label class="text-sm font-medium text-slate-500">New Departure Time</label>
                        <p id="newTimeDep" class="font-semibold text-lg rounded-full px-4 py-1 mt-1 animate-flash"></p>
                    </div>
                    <div id="delayDurationContainer" class="hidden">
                        <label class="text-sm font-medium text-slate-500">Delay Duration</label>
                        <p class="text-slate-800 font-semibold text-lg"><span id="delayH"></span>H <span id="delayM"></span>M</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Gate</label>
                        <p id="gate" class="text-slate-800 font-semibold text-lg"></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Aircraft Type</label>
                        <p id="aircraftType" class="text-slate-800 font-semibold text-lg"></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Flight Duration</label>
                        <p id="flightTime" class="text-slate-800 font-semibold text-lg"></p>
                    </div>
                </div>

                <!-- PTS Section -->
                <div class="md-col-span-1 space-y-6">
                    <h3 class="font-bold text-lg text-slate-700 border-b pb-2">PTS</h3>
                    <!-- Timer Control Section -->
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div id="timeContainer" class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-sm font-semibold text-slate-700">Device Time</p>
                                <p id="currentTime" class="text-lg font-bold text-blue-600 tracking-wider">--:--:--</p>
                            </div>
                            <div id="departureTimeWrapper" class="text-center">
                                <p id="departureTimeLabel" class="text-sm font-semibold text-slate-700">Departure Local Time</p>
                                <p id="departureTime" class="text-lg font-bold text-blue-600 tracking-wider">--:--:--</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <button id="startTimerBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md w-full focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                                Start Timer
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Crew Onboard</label>
                        <div class="flex items-center justify-between">
                            <p id="crewTime" class="text-green-600 font-bold text-lg"></p>
                            <button data-field="crewOnboard" data-target-id="crewTimeRecorded" data-wrapper-id="crewTimeRecordedWrapper" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                        <div id="crewTimeRecordedWrapper" class="hidden mt-1 text-right">
                            <span class="text-xs font-semibold text-slate-500">Recorded:</span>
                            <span id="crewTimeRecorded" class="text-sm font-bold text-slate-700"></span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Pre Boards</label>
                        <div class="flex items-center justify-between">
                            <p id="preBoardsTime" class="text-indigo-600 font-bold text-lg"></p>
                            <button data-field="preBoards" data-target-id="preBoardsTimeRecorded" data-wrapper-id="preBoardsTimeRecordedWrapper" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                         <div id="preBoardsTimeRecordedWrapper" class="hidden mt-1 text-right">
                            <span class="text-xs font-semibold text-slate-500">Recorded:</span>
                            <span id="preBoardsTimeRecorded" class="text-sm font-bold text-slate-700"></span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">General Boarding</label>
                         <div class="flex items-center justify-between">
                            <p id="boardingTime" class="text-orange-600 font-bold text-lg"></p>
                            <button data-field="generalBoarding" data-target-id="boardingTimeRecorded" data-wrapper-id="boardingTimeRecordedWrapper" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                        <div id="boardingTimeRecordedWrapper" class="hidden mt-1 text-right">
                            <span class="text-xs font-semibold text-slate-500">Recorded:</span>
                            <span id="boardingTimeRecorded" class="text-sm font-bold text-slate-700"></span>
                        </div>
                    </div>
                    <!-- NEW: Last Pax Onboard -->
                    <div>
                        <label class="text-sm font-medium text-slate-500">Last Pax Onboard</label>
                         <div class="flex items-center justify-between">
                            <p id="lastPaxTime" class="text-cyan-600 font-bold text-lg"></p>
                            <button data-field="lastPaxOnboard" data-target-id="lastPaxTimeRecorded" data-wrapper-id="lastPaxTimeRecordedWrapper" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                        <div id="lastPaxTimeRecordedWrapper" class="hidden mt-1 text-right">
                            <span class="text-xs font-semibold text-slate-500">Recorded:</span>
                            <span id="lastPaxTimeRecorded" class="text-sm font-bold text-slate-700"></span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Door Closed</label>
                         <div class="flex items-center justify-between">
                            <p id="doorTime" class="text-red-600 font-bold text-lg"></p>
                            <button data-field="doorClosed" data-target-id="doorTimeRecorded" data-wrapper-id="doorTimeRecordedWrapper" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                         <div id="doorTimeRecordedWrapper" class="hidden mt-1 text-right">
                            <span class="text-xs font-semibold text-slate-500">Recorded:</span>
                            <span id="doorTimeRecorded" class="text-sm font-bold text-slate-700"></span>
                        </div>
                    </div>
                     <div>
                        <label class="text-sm font-medium text-slate-500">Security Off</label>
                        <div class="flex items-center justify-between">
                            <p id="securityOffTimeRecorded" class="text-slate-700 font-bold text-lg">Not Recorded</p>
                            <button data-field="securityOff" data-target-id="securityOffTimeRecorded" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-500">Catering Off</label>
                        <div class="flex items-center justify-between">
                            <p id="cateringOffTimeRecorded" class="text-slate-700 font-bold text-lg">Not Recorded</p>
                            <button data-field="cateringOff" data-target-id="cateringOffTimeRecorded" class="record-time-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-3 rounded-full">Record</button>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="md:col-span-2 mt-6">
                    <h3 class="font-bold text-lg text-slate-700 border-b pb-2 mb-2">Notes</h3>
                    <textarea id="notesTextarea" rows="4" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Add any notes here..."></textarea>
                    <div class="text-right mt-2">
                        <button id="saveNotesBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                            Save Notes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons Section -->
        <div class="p-6 bg-slate-50 border-t border-slate-200">
            <div class="grid grid-cols-2 gap-4">
                <button id="generateReportBtn" class="block w-full text-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                    Generate Report
                </button>
                <a id="createNewPtsBtn" href="https://www.myallowancesapp.com/pts-form" target="_blank" rel="noopener noreferrer" class="block w-full text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                    Create New PTS
                </a>
            </div>

            <!-- Conditional Actions based on source -->
            <div id="appSourceActions" class="hidden mt-4 text-center">
                 <button id="copyLinkBtn" class="w-full text-center bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75">
                    Copy Link
                </button>
                <p class="text-xs text-slate-500 mt-2">This link can be pasted in a browser if required.</p>
            </div>

            <div id="websiteSourceActions" class="hidden mt-4 text-center">
                 <p class="text-xs text-slate-500">This page can be revisited by saving this link. Links expire after 7 days.</p>
            </div>
        </div>
    </div>
    <div id="messageCenter" class="text-center"></div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto p-6 relative animate-fade-in">
            <button id="closeReportBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Flight Report</h2>
            <div id="reportContent"></div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyCoI0RVe0DehkFjyIsOPv77rJiFnmpAS00",
          authDomain: "allowances-app-pts.firebaseapp.com",
          projectId: "allowances-app-pts",
          storageBucket: "allowances-app-pts.appspot.com",
          messagingSenderId: "361466324685",
          appId: "1:361466324685:web:8bafbe42ab8a09914feb84",
          measurementId: "G-0ZK1XKCTS7"
        };

        let db;
        
        async function initializeAndFetch() {
            if (firebaseConfig) {
                console.log("Firebase config found. Initializing...");
                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    db = getFirestore(app);
                    console.log("Firebase initialized successfully.");
                    
                    await signInAnonymously(auth);
                    console.log("Auth successful. User UID:", auth.currentUser?.uid);
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    document.getElementById('messageCenter').innerHTML = `<h1 class="text-2xl font-bold text-red-600">Error</h1><p class="text-slate-600 mt-2">Could not connect to the database. Check console for details.</p>`;
                    return;
                }
            } else {
                 console.error("Firebase configuration is missing.");
                 document.getElementById('messageCenter').innerHTML = `<h1 class="text-2xl font-bold text-red-600">Configuration Error</h1><p class="text-slate-600 mt-2">Firebase configuration is missing.</p>`;
                 return;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const flightId = urlParams.get('id');
            const messageCenter = document.getElementById('messageCenter');
            
            console.log("DOM loaded. Flight ID from URL:", flightId);

            if (flightId) {
                messageCenter.innerHTML = `<p class="text-slate-600">Loading flight data for ${flightId}...</p>`;
                setupRealtimeListener(flightId);
            } else {
                messageCenter.innerHTML = `<h1 class="text-2xl font-bold">No Flight Specified</h1><p class="text-slate-600 mt-2">Please provide a flight ID from your Firebase 'flights' collection in the URL. <br>Example: ?id=QF430-20251005</p>`;
            }
        }
        
        function setupRealtimeListener(flightId) {
            if (!db) {
                console.error("Firestore database instance (db) is not available.");
                return;
            }
            const docRef = doc(db, 'artifacts/allowances-app-pts/public/data/flights', flightId);

            onSnapshot(docRef, (docSnap) => {
                const messageCenter = document.getElementById('messageCenter');
                if (docSnap.exists()) {
                    console.log("Realtime update received:", docSnap.id, docSnap.data());
                    messageCenter.classList.add('hidden');
                    document.getElementById('flightCard').classList.remove('hidden');
                    populatePage(docSnap.data(), flightId);
                } else {
                    console.log("Document does not exist at the specified path.");
                    messageCenter.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Not Found</h1><p class="text-slate-600 mt-2">No flight data found for ID: ${flightId}. Please check the ID and the Firestore path.</p>`;
                }
            }, (error) => {
                 console.error("Caught error in realtime listener:", error);
                 const messageCenter = document.getElementById('messageCenter');
                 messageCenter.innerHTML = `<h1 class="text-2xl font-bold text-red-600">Error</h1><p class="text-slate-600 mt-2">Could not retrieve flight data in realtime. This is often a permission issue. Please check your Firestore Security Rules. The specific error is: <br><code class="text-sm text-red-500">${error.message}</code></p>`;
            });
        }

        function populatePage(data, flightId) {
            // Store data globally for timer functions to access
            window.currentFlightData = data;

            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || '';
            };
             const setValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value || '';
            };
            
            setText('delayStatus', data.delayStatus);
            setText('iataFrom', data.iataFrom);
            setText('fromCityCountry', `${data.cityFrom}, ${data.countryFrom}`);
            setText('iataTo', data.iataTo);
            setText('toCityCountry', `${data.cityTo}, ${data.countryTo}`);
            setText('flightNumber', data.flightNumber);
            setText('departScheduled', data.departScheduled);
            setText('newTimeDep', data.newTimeDep);
            setText('delayH', data.delayH);
            setText('delayM', data.delayM);
            setText('gate', data.gate);
            setText('aircraftType', data.aircraftType);
            setText('flightTime', data.flightTime);
            setText('crewTime', data.crewOnboard);
            setText('preBoardsTime', data.preBoards);
            setText('boardingTime', data.generalBoarding);
            setText('lastPaxTime', data.lastPaxOnboard); // New field
            setText('doorTime', data.doorClosed);
            setValue('notesTextarea', data.notes);

            // Handle source-based UI changes
            const source = data.source;
            const createNewPtsBtn = document.getElementById('createNewPtsBtn');
            const appSourceActions = document.getElementById('appSourceActions');
            const websiteSourceActions = document.getElementById('websiteSourceActions');

            // Hide both to reset state on data refresh
            if (appSourceActions) appSourceActions.classList.add('hidden');
            if (websiteSourceActions) websiteSourceActions.classList.add('hidden');
            
            if (source === 'website') {
                if (createNewPtsBtn) createNewPtsBtn.href = 'https://new.faaa.com.au/precision-timing-schedule/';
                if (websiteSourceActions) websiteSourceActions.classList.remove('hidden');
            } else if (source === 'app') {
                if (createNewPtsBtn) createNewPtsBtn.href = 'https://www.myallowancesapp.com/pts-form';
                if (appSourceActions) appSourceActions.classList.remove('hidden');
            } else {
                 if (createNewPtsBtn) createNewPtsBtn.href = 'https://www.myallowancesapp.com/pts-form';
            }


            const checkAndSetRecordedTime = (baseId, actualValue) => {
                const wrapper = document.getElementById(`${baseId}RecordedWrapper`);
                const element = document.getElementById(`${baseId}Recorded`);
                const button = document.querySelector(`button[data-target-id="${baseId}Recorded"]`);

                if (actualValue) {
                    if (wrapper && element) {
                        element.textContent = actualValue;
                        wrapper.classList.remove('hidden');
                    }
                    if (button) {
                        button.disabled = true;
                        button.textContent = 'Saved';
                        button.classList.add('bg-green-200', 'text-green-800');
                    }
                } else {
                     if (wrapper) wrapper.classList.add('hidden');
                     if(button) {
                        button.disabled = false;
                        button.textContent = 'Record';
                        button.classList.remove('bg-green-200', 'text-green-800');
                     }
                }
            };

            const checkAndSetSimpleRecordedTime = (baseId, actualValue) => {
                const element = document.getElementById(`${baseId}Recorded`);
                const button = document.querySelector(`button[data-target-id="${baseId}Recorded"]`);

                if (actualValue) {
                    if (element) element.textContent = actualValue;
                    if (button) {
                        button.disabled = true;
                        button.textContent = 'Saved';
                        button.classList.add('bg-green-200', 'text-green-800');
                    }
                } else {
                     if (element) element.textContent = 'Not Recorded';
                     if(button) {
                        button.disabled = false;
                        button.textContent = 'Record';
                        button.classList.remove('bg-green-200', 'text-green-800');
                     }
                }
            };

            checkAndSetRecordedTime('crewTime', data.crewOnboard_actual);
            checkAndSetRecordedTime('preBoardsTime', data.preBoards_actual);
            checkAndSetRecordedTime('boardingTime', data.generalBoarding_actual);
            checkAndSetRecordedTime('lastPaxTime', data.lastPaxOnboard_actual); // New field
            checkAndSetRecordedTime('doorTime', data.doorClosed_actual);
            checkAndSetSimpleRecordedTime('securityOffTime', data.securityOff_actual);
            checkAndSetSimpleRecordedTime('cateringOffTime', data.cateringOff_actual);

            // This flag ensures UI elements (like event listeners) are only set up once.
            if (!window.uiInitialized) {
                initializeUI(data.iataFrom, flightId);
                window.uiInitialized = true;
            }
        }

        function initializeUI(departureIATA, flightId) {
            const timezoneMap = {
                'ADL': 'Australia/Adelaide', 'ABX': 'Australia/Sydney', 'ASP': 'Australia/Darwin', 'ARM': 'Australia/Sydney', 'BNK': 'Australia/Sydney', 'BCI': 'Australia/Brisbane', 'BXG': 'Australia/Melbourne', 'BKQ': 'Australia/Brisbane', 'BNE': 'Australia/Brisbane', 'BHQ': 'Australia/Broken_Hill', 'BME': 'Australia/Perth', 'BDB': 'Australia/Brisbane', 'BWT': 'Australia/Hobart', 'BQB': 'Australia/Perth', 'CNS': 'Australia/Brisbane', 'CBR': 'Australia/Canberra', 'CNJ': 'Australia/Brisbane', 'CFS': 'Australia/Sydney', 'DRW': 'Australia/Darwin', 'DPO': 'Australia/Hobart', 'DBO': 'Australia/Sydney', 'EMD': 'Australia/Brisbane', 'LEA': 'Australia/Perth', 'GET': 'Australia/Perth', 'GLT': 'Australia/Brisbane', 'OOL': 'Australia/Brisbane', 'GFF': 'Australia/Sydney', 'HTI': 'Australia/Brisbane', 'HVB': 'Australia/Brisbane', 'HBA': 'Australia/Hobart', 'HID': 'Australia/Brisbane', 'KGI': 'Australia/Perth', 'KTA': 'Australia/Perth', 'KGC': 'Australia/Adelaide', 'LST': 'Australia/Hobart', 'LRE': 'Australia/Brisbane', 'LDH': 'Australia/Lord_Howe', 'MKY': 'Australia/Brisbane', 'MEL': 'Australia/Melbourne', 'MIM': 'Australia/Sydney', 'MQL': 'Australia/Melbourne', 'WLE': 'Australia/Brisbane', 'MOV': 'Australia/Brisbane', 'MRZ': 'Australia/Sydney', 'MGB': 'Australia/Adelaide', 'ISA': 'Australia/Brisbane', 'NTL': 'Australia/Sydney', 'ZNE': 'Australia/Perth', 'ONS': 'Australia/Perth', 'OAG': 'Australia/Sydney', 'PBO': 'Australia/Perth', 'PER': 'Australia/Perth', 'PHE': 'Australia/Perth', 'PLO': 'Australia/Adelaide', 'PQQ': 'Australia/Sydney', 'PPP': 'Australia/Brisbane', 'ROK': 'Australia/Brisbane', 'MCY': 'Australia/Brisbane', 'SYD': 'Australia/Sydney', 'TMW': 'Australia/Sydney', 'WTB': 'Australia/Brisbane', 'TSV': 'Australia/Brisbane', 'WGA': 'Australia/Sydney', 'WEI': 'Australia/Brisbane', 'WYA': 'Australia/Adelaide', 'AYQ': 'Australia/Darwin',
                'YVR': 'America/Vancouver', 'SCL': 'America/Santiago', 'HKG': 'Asia/Hong_Kong', 'BLR': 'Asia/Kolkata', 'DEL': 'Asia/Kolkata', 'DPS': 'Asia/Makassar', 'CGK': 'Asia/Jakarta', 'FCO': 'Europe/Rome', 'CTS': 'Asia/Tokyo', 'HND': 'Asia/Tokyo', 'NRT': 'Asia/Tokyo', 'NOU': 'Pacific/Noumea', 'AKL': 'Pacific/Auckland', 'CHC': 'Pacific/Auckland', 'ZQN': 'Pacific/Auckland', 'WLG': 'Pacific/Auckland', 'NLK': 'Pacific/Norfolk', 'ROR': 'Pacific/Palau', 'POM': 'Pacific/Port_Moresby', 'MNL': 'Asia/Manila', 'APW': 'Pacific/Apia', 'SIN': 'Asia/Singapore', 'HIR': 'Pacific/Guadalcanal', 'JNB': 'Africa/Johannesburg', 'BKK': 'Asia/Bangkok', 'DIL': 'Asia/Dili', 'TBU': 'Pacific/Tongatapu', 'LHR': 'Europe/London', 'DFW': 'America/Chicago', 'HNL': 'Pacific/Honolulu', 'LAX': 'America/Los_Angeles', 'JFK': 'America/New_York', 'SFO': 'America/Los_Angeles', 'VLI': 'Pacific/Efate'
            };
            const departureTimeZone = timezoneMap[departureIATA];

            const startBtn = document.getElementById('startTimerBtn');
            const currentTimeEl = document.getElementById('currentTime');
            const departureTimeEl = document.getElementById('departureTime');
            const departureTimeLabelEl = document.getElementById('departureTimeLabel');
            const departureTimeWrapper = document.getElementById('departureTimeWrapper');
            const timeContainer = document.getElementById('timeContainer');
            const delayStatusEl = document.getElementById('delayStatus');
            const statusLabelEl = document.getElementById('statusLabel');
            const delayDurationContainerEl = document.getElementById('delayDurationContainer');
            const newDepartureTimeContainerEl = document.getElementById('newDepartureTimeContainer');
            
            if (departureTimeLabelEl) {
                departureTimeLabelEl.textContent = `${departureIATA} Time`;
            }

            if (!departureTimeZone) {
                if(departureTimeWrapper) departureTimeWrapper.classList.add('hidden');
                if(timeContainer) timeContainer.classList.remove('grid-cols-2');
                if(timeContainer) timeContainer.classList.add('grid-cols-1');
            }

            // --- Report Modal Logic ---
            const reportModal = document.getElementById('reportModal');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const closeReportBtn = document.getElementById('closeReportBtn');
            const reportContent = document.getElementById('reportContent');

            const generateReportHTML = (data) => {
                const flightDetailsHTML = `
                    <div class="border-b pb-4 mb-4">
                        <h3 class="text-xl font-bold text-slate-700 mb-2">Flight Summary</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                            <div><strong>Flight:</strong> QF${data.flightNumber || 'N/A'}</div>
                            <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                            <div><strong>Route:</strong> ${data.iataFrom || 'N/A'} â†’ ${data.iataTo || 'N/A'}</div>
                            <div><strong>Aircraft:</strong> ${data.aircraftType || 'N/A'}</div>
                            <div><strong>Scheduled Dep:</strong> ${data.departScheduled || 'N/A'}</div>
                            <div><strong>Status:</strong> ${data.delayStatus || 'N/A'}</div>
                        </div>
                    </div>`;

                const times = [
                    { label: 'Crew Onboard', planned: data.crewOnboard, actual: data.crewOnboard_actual },
                    { label: 'Pre Boards', planned: data.preBoards, actual: data.preBoards_actual },
                    { label: 'General Boarding', planned: data.generalBoarding, actual: data.generalBoarding_actual },
                    { label: 'Last Pax Onboard', planned: data.lastPaxOnboard, actual: data.lastPaxOnboard_actual }, // New field
                    { label: 'Door Closed', planned: data.doorClosed, actual: data.doorClosed_actual },
                    { label: 'Security Off', planned: 'N/A', actual: data.securityOff_actual },
                    { label: 'Catering Off', planned: 'N/A', actual: data.cateringOff_actual }
                ];

                const timesRowsHTML = times.map(time => `
                    <tr class="border-t">
                        <td class="px-2 py-3 font-medium text-slate-600">${time.label}</td>
                        <td class="px-2 py-3 text-slate-500">${time.planned || 'N/A'}</td>
                        <td class="px-2 py-3 font-bold text-slate-800">${time.actual || 'Not Recorded'}</td>
                    </tr>
                `).join('');

                const notesHTML = `
                    <div class="mt-4">
                         <h3 class="text-xl font-bold text-slate-700 mb-2">Notes</h3>
                         <p class="text-sm text-slate-600 whitespace-pre-wrap">${data.notes || 'No notes added.'}</p>
                    </div>`;

                const timesTableHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-slate-700 mb-2">PTS Timings</h3>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-2 py-2 font-semibold">Event</th>
                                    <th class="px-2 py-2 font-semibold">Planned Time</th>
                                    <th class="px-2 py-2 font-semibold">Recorded Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${timesRowsHTML}
                            </tbody>
                        </table>
                    </div>`;
                
                return flightDetailsHTML + timesTableHTML + notesHTML;
            };

            generateReportBtn.addEventListener('click', () => {
                if (window.currentFlightData) {
                    reportContent.innerHTML = generateReportHTML(window.currentFlightData);
                    reportModal.classList.remove('hidden');
                } else {
                    alert("Flight data is not available to generate a report.");
                }
            });
            
            const closeTheModal = () => reportModal.classList.add('hidden');
            closeReportBtn.addEventListener('click', closeTheModal);
            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    closeTheModal();
                }
            });


            const recordButtons = document.querySelectorAll('.record-time-btn');
            recordButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const fieldBaseName = btn.dataset.field;
                    const fieldToUpdate = fieldBaseName + '_actual';

                    if (!departureTimeZone) {
                        alert("Departure time zone is not set, cannot record local time.");
                        return;
                    }

                    const now = new Date();
                    const formattedTime = new Intl.DateTimeFormat('en-GB', {
                        timeZone: departureTimeZone,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).format(now);

                    btn.disabled = true;
                    btn.textContent = 'Saving...';

                    try {
                        const docRef = doc(db, 'artifacts/allowances-app-pts/public/data/flights', flightId);
                        await updateDoc(docRef, { [fieldToUpdate]: formattedTime });
                        console.log(`Successfully updated ${fieldToUpdate} to ${formattedTime}`);
                    } catch (error) {
                        console.error(`Failed to update ${fieldBaseName}:`, error);
                        btn.disabled = false;
                        btn.textContent = 'Retry';
                        alert(`Failed to save the time. Please check your Firestore security rules and console for errors.`);
                    }
                });
            });
            
            // --- Notes Logic ---
            const notesTextarea = document.getElementById('notesTextarea');
            const saveNotesBtn = document.getElementById('saveNotesBtn');

            saveNotesBtn.addEventListener('click', async () => {
                const notes = notesTextarea.value;
                saveNotesBtn.disabled = true;
                saveNotesBtn.textContent = 'Saving...';

                try {
                    const docRef = doc(db, 'artifacts/allowances-app-pts/public/data/flights', flightId);
                    await updateDoc(docRef, { notes: notes });
                    console.log(`Successfully updated notes.`);
                    saveNotesBtn.textContent = 'Saved!';
                    setTimeout(() => {
                        saveNotesBtn.textContent = 'Save Notes';
                        saveNotesBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error(`Failed to update notes:`, error);
                    saveNotesBtn.textContent = 'Retry';
                    saveNotesBtn.disabled = false;
                    alert(`Failed to save notes. Please check your Firestore security rules and console for errors.`);
                }
            });
            
             // --- Copy Link Logic ---
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', () => {
                    const urlToCopy = window.location.href;
                    const textArea = document.createElement("textarea");
                    textArea.value = urlToCopy;
                    textArea.style.top = "0";
                    textArea.style.left = "0";
                    textArea.style.position = "fixed";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyLinkBtn.textContent = 'Copied!';
                        setTimeout(() => { copyLinkBtn.textContent = 'Copy Link'; }, 2000);
                    } catch (err) {
                        console.error('Failed to copy link', err);
                        copyLinkBtn.textContent = 'Error';
                    }
                    document.body.removeChild(textArea);
                });
            }


            const crewTimeEl = document.getElementById('crewTime');
            const preBoardsTimeEl = document.getElementById('preBoardsTime');
            const boardingTimeEl = document.getElementById('boardingTime');
            const lastPaxTimeEl = document.getElementById('lastPaxTime'); // New field
            const doorTimeEl = document.getElementById('doorTime');
            
            let timerInterval = null;
            let isTimerRunning = false;

            const handleDelayStatus = () => {
                const statusText = delayStatusEl.textContent.trim().toLowerCase();
                if (statusText === 'on time') {
                    delayStatusEl.classList.add('text-green-700', 'bg-green-100');
                    statusLabelEl.classList.add('text-green-600');
                    delayDurationContainerEl.classList.add('hidden');
                    newDepartureTimeContainerEl.classList.add('hidden');
                } else {
                    delayStatusEl.classList.add('text-red-700', 'bg-red-100');
                    statusLabelEl.classList.add('text-red-600');
                    delayDurationContainerEl.classList.remove('hidden');
                    newDepartureTimeContainerEl.classList.remove('hidden');
                }
            };
            
            const updateClocks = () => {
                const now = new Date();
                if (currentTimeEl) {
                    currentTimeEl.textContent = now.toLocaleTimeString('en-US');
                }
                if (departureTimeEl && departureTimeZone) {
                    try {
                        departureTimeEl.textContent = now.toLocaleTimeString('en-US', { timeZone: departureTimeZone, hour12: false });
                    } catch (e) {
                        departureTimeEl.textContent = "Invalid Zone";
                    }
                }
            };
            
            const getTargetTime = (timeString) => {
                if (!timeString) return null; // FIX: Prevent error if timeString is undefined
                const timeRegex = /^(\d{1,2}):(\d{2})(:(\d{2}))?$/;
                const match = timeString.match(timeRegex);

                if (match && departureTimeZone) {
                    const now = new Date();
                    const dateParts = new Intl.DateTimeFormat('en-CA', { timeZone: departureTimeZone }).format(now).split(' ')[0];
                    const hours = match[1].padStart(2, '0');
                    const minutes = match[2].padStart(2, '0');
                    const seconds = match[4] ? match[4].padStart(2, '0') : '00';
                    const isoDateString = `${dateParts}T${hours}:${minutes}:${seconds}`;

                    const dateInTargetZone = new Date(now.toLocaleString('en-US', { timeZone: departureTimeZone }));
                    const dateInLocalZone = new Date(now.toLocaleString('en-US'));
                    const offset = dateInTargetZone.getTime() - dateInLocalZone.getTime();
                    
                    const localTargetDate = new Date(isoDateString);
                    return new Date(localTargetDate.getTime() - offset);
                }
                return null;
            };

            const updateCountdowns = () => {
                const now = new Date();
                const docData = window.currentFlightData || {};

                const updateTimerElement = (el, plannedTime, actualTime) => {
                    if (actualTime) {
                        el.textContent = actualTime; // If there's a recorded time, show it.
                        return;
                    }
                    const targetTime = getTargetTime(plannedTime);
                    if (targetTime) {
                        const diff = targetTime.getTime() - now.getTime();
                        if (diff > 0) {
                            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                            const minutes = Math.floor((diff / 1000 / 60) % 60).toString().padStart(2, '0');
                            const seconds = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
                            el.textContent = `-${hours}:${minutes}:${seconds}`;
                        } else {
                            el.textContent = `COMPLETED`;
                            el.classList.remove('text-green-600', 'text-orange-600', 'text-red-600', 'text-indigo-600', 'text-cyan-600');
                            el.classList.add('text-slate-500');
                        }
                    } else {
                        el.textContent = plannedTime || ''; // Show planned time or empty string
                    }
                };

                updateTimerElement(crewTimeEl, docData.crewOnboard, docData.crewOnboard_actual);
                updateTimerElement(preBoardsTimeEl, docData.preBoards, docData.preBoards_actual);
                updateTimerElement(boardingTimeEl, docData.generalBoarding, docData.generalBoarding_actual);
                updateTimerElement(lastPaxTimeEl, docData.lastPaxOnboard, docData.lastPaxOnboard_actual); // New field
                updateTimerElement(doorTimeEl, docData.doorClosed, docData.doorClosed_actual);
            };
            
            const stopTimer = () => {
                clearInterval(timerInterval);
                timerInterval = null;
                const docData = window.currentFlightData || {};
                crewTimeEl.textContent = docData.crewOnboard || '';
                preBoardsTimeEl.textContent = docData.preBoards || '';
                boardingTimeEl.textContent = docData.generalBoarding || '';
                lastPaxTimeEl.textContent = docData.lastPaxOnboard || ''; // New field
                doorTimeEl.textContent = docData.doorClosed || '';
                
                if (startBtn) {
                    startBtn.textContent = 'Start Timer';
                    startBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    startBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }
                isTimerRunning = false;
            };

            const startTimer = () => {
                updateCountdowns();
                timerInterval = setInterval(updateCountdowns, 1000);
                if(startBtn) {
                    startBtn.textContent = 'Stop Timer';
                    startBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    startBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }
                isTimerRunning = true;
            };
            
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    if (isTimerRunning) {
                        stopTimer();
                    } else {
                        startTimer();
                    }
                });
            }
            
            handleDelayStatus();
            updateClocks();
            setInterval(updateClocks, 1000);
        
        }

        // Run the initialization and fetching logic
        initializeAndFetch();
    </script>
</body>
</html>
